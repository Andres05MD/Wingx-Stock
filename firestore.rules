rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda (Helpers) ---

    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica si el userId coincide con el usuario autenticado
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verifica si el usuario tiene rol de administrador
    // Lee el documento en la colección 'users' para chequear el campo 'role'
    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Verifica si el documento existente pertenece al usuario (campo ownerId)
    function isResourceOwner() {
      return isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // Verifica si el documento a crear/actualizar pertenecerá al usuario (campo ownerId)
    function willBeResourceOwner() {
      return isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    // --- Reglas para la Colección de Usuarios ---
    match /users/{userId} {
      // Leer: El propio usuario o administradores
      allow read: if isOwner(userId) || isAdmin();
      
      // Crear: Permitir creación al registrarse (el usuario debe ser el owner)
      // Se previene que un usuario normal se asigne rol 'admin' al crear
      allow create: if isOwner(userId) && 
        (!('role' in request.resource.data) || request.resource.data.role == 'user' || isAdmin());
      
      // Actualizar: El propio usuario o administradores
      // Se previene que un usuario cambie su propio rol a 'admin'
      allow update: if isAdmin() || (
        isOwner(userId) && 
        (!('role' in request.resource.data) || request.resource.data.role == resource.data.role)
      );
      
      // Borrar: Solo administradores
      allow delete: if isAdmin();
    }

    // --- Reglas para Colecciones de Datos (con ownerId) ---
    // Aplica a: garments, clients, orders, materials, stock, supplies, events
    match /{collectionName}/{docId} {
      
      function isKnownCollection() {
        return collectionName in ['garments', 'clients', 'orders', 'materials', 'stock', 'supplies', 'events'];
      }

      // Leer: Dueño o Admin
      allow read: if isKnownCollection() && (isResourceOwner() || isAdmin());
      
      // Crear: Debe ser el dueño (ownerId == uid)
      allow create: if isKnownCollection() && willBeResourceOwner();
      
      // Actualizar: Dueño o Admin. No se puede transferir propiedad (cambiar ownerId) a menos que seas Admin.
      allow update: if isKnownCollection() && 
        (isResourceOwner() || isAdmin()) &&
        (willBeResourceOwner() || isAdmin());

      // Borrar: Dueño o Admin
      allow delete: if isKnownCollection() && (isResourceOwner() || isAdmin());
    }
  }
}
